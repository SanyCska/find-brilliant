name: Setup Server Secrets

# This workflow helps set up environment variables on your server
# Run this once after initial server setup

on:
  workflow_dispatch:
    inputs:
      update_secrets:
        description: 'Update secrets on server'
        required: true
        type: boolean
        default: true

jobs:
  setup-secrets:
    name: Setup Environment on Server
    runs-on: ubuntu-latest
    
    env:
      API_ID: ${{ secrets.API_ID }}
      API_HASH: ${{ secrets.API_HASH }}
      TARGET_USER_ID: ${{ secrets.TARGET_USER_ID }}
      KEYWORDS: ${{ secrets.KEYWORDS }}
      AUTO_REPLY_ENABLED: ${{ secrets.AUTO_REPLY_ENABLED }}
      AUTO_REPLY_TEXT: ${{ secrets.AUTO_REPLY_TEXT }}
      AUTO_REPLY_MIN_DELAY: ${{ secrets.AUTO_REPLY_MIN_DELAY }}
      AUTO_REPLY_MAX_DELAY: ${{ secrets.AUTO_REPLY_MAX_DELAY }}
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create environment script on server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "üìù Creating environment variables on server..."
          
          # Create a secure environment file on the server
          ssh ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            cd ${DEPLOY_PATH}
            
            # Create .env.production with secrets
            cat > .env.production << EOF
# Generated from GitHub Secrets
export API_ID="${API_ID}"
export API_HASH="${API_HASH}"
export TARGET_USER_ID="${TARGET_USER_ID}"
export KEYWORDS="${KEYWORDS}"
export AUTO_REPLY_ENABLED="${AUTO_REPLY_ENABLED}"
export AUTO_REPLY_TEXT="${AUTO_REPLY_TEXT}"
export AUTO_REPLY_MIN_DELAY="${AUTO_REPLY_MIN_DELAY}"
export AUTO_REPLY_MAX_DELAY="${AUTO_REPLY_MAX_DELAY}"
EOF
            
            # Secure the file
            chmod 600 .env.production
            
            # Create helper scripts
            cat > start.sh << 'SCRIPT'
#!/bin/bash
source .env.production
docker-compose -f docker-compose.ci.yml up -d
SCRIPT
            
            cat > restart.sh << 'SCRIPT'
#!/bin/bash
docker-compose -f docker-compose.ci.yml restart
SCRIPT
            
            cat > stop.sh << 'SCRIPT'
#!/bin/bash
docker-compose -f docker-compose.ci.yml down
SCRIPT
            
            cat > logs.sh << 'SCRIPT'
#!/bin/bash
docker-compose -f docker-compose.ci.yml logs -f
SCRIPT
            
            # Make scripts executable
            chmod +x start.sh restart.sh stop.sh logs.sh
            
            echo "‚úÖ Environment setup complete!"
            echo "Available commands:"
            echo "  ./start.sh   - Start the bot"
            echo "  ./restart.sh - Restart the bot"
            echo "  ./stop.sh    - Stop the bot"
            echo "  ./logs.sh    - View logs"
          ENDSSH
      
      - name: Test environment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "üß™ Testing environment setup..."
          ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && source .env.production && echo 'API_ID is set: ' && [ ! -z \"\$API_ID\" ] && echo '‚úÖ Yes' || echo '‚ùå No'"
      
      - name: Summary
        run: |
          echo "## Server Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Environment variables configured on server" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Helper scripts created:" >> $GITHUB_STEP_SUMMARY
          echo "- start.sh" >> $GITHUB_STEP_SUMMARY
          echo "- restart.sh" >> $GITHUB_STEP_SUMMARY
          echo "- stop.sh" >> $GITHUB_STEP_SUMMARY
          echo "- logs.sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH to your server" >> $GITHUB_STEP_SUMMARY
          echo "2. Run: cd ${{ secrets.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "3. Run: ./start.sh" >> $GITHUB_STEP_SUMMARY


