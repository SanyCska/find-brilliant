name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # This creates the manual trigger button in GitHub UI

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          TARGET_USER_ID: ${{ secrets.TARGET_USER_ID }}
          KEYWORDS: ${{ secrets.KEYWORDS }}
          AUTO_REPLY_ENABLED: ${{ secrets.AUTO_REPLY_ENABLED }}
          AUTO_REPLY_TEXT: ${{ secrets.AUTO_REPLY_TEXT }}
          AUTO_REPLY_MIN_DELAY: ${{ secrets.AUTO_REPLY_MIN_DELAY }}
          AUTO_REPLY_MAX_DELAY: ${{ secrets.AUTO_REPLY_MAX_DELAY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          
          # Deploy to server
          ssh -i ~/.ssh/deploy_key "${SSH_USER}@${SSH_HOST}" << 'ENDSSH'
            cd ${DEPLOY_PATH}
            
            # Pull latest code
            git pull origin main
            
            # Export environment variables
            export API_ID="${API_ID}"
            export API_HASH="${API_HASH}"
            export TARGET_USER_ID="${TARGET_USER_ID}"
            export KEYWORDS="${KEYWORDS}"
            export AUTO_REPLY_ENABLED="${AUTO_REPLY_ENABLED:-false}"
            export AUTO_REPLY_TEXT="${AUTO_REPLY_TEXT}"
            export AUTO_REPLY_MIN_DELAY="${AUTO_REPLY_MIN_DELAY:-5}"
            export AUTO_REPLY_MAX_DELAY="${AUTO_REPLY_MAX_DELAY:-15}"
            
            # Deploy with docker compose
            docker compose -f docker-compose.ci.yml pull
            docker compose -f docker-compose.ci.yml up -d --build
            
            # Show status
            docker compose -f docker-compose.ci.yml ps
            echo "Deployment completed!"
          ENDSSH
      
      - name: Verify deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Check if container is running
          ssh -i ~/.ssh/deploy_key "${SSH_USER}@${SSH_HOST}" << 'ENDSSH'
            cd ${DEPLOY_PATH}
            docker compose -f docker-compose.ci.yml ps
            docker compose -f docker-compose.ci.yml logs --tail=20
          ENDSSH
