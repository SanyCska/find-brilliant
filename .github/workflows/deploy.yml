name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # This creates the manual trigger button in GitHub UI

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          TARGET_USER_ID: ${{ secrets.TARGET_USER_ID }}
          KEYWORDS: ${{ secrets.KEYWORDS }}
          AUTO_REPLY_ENABLED: ${{ secrets.AUTO_REPLY_ENABLED }}
          AUTO_REPLY_TEXT: ${{ secrets.AUTO_REPLY_TEXT }}
          AUTO_REPLY_MIN_DELAY: ${{ secrets.AUTO_REPLY_MIN_DELAY }}
          AUTO_REPLY_MAX_DELAY: ${{ secrets.AUTO_REPLY_MAX_DELAY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          
          # Create .env content
          {
            echo "API_ID=$API_ID"
            echo "API_HASH=$API_HASH"
            echo "TARGET_USER_ID=$TARGET_USER_ID"
            echo "KEYWORDS=$KEYWORDS"
            echo "AUTO_REPLY_ENABLED=${AUTO_REPLY_ENABLED:-false}"
            echo "AUTO_REPLY_TEXT=$AUTO_REPLY_TEXT"
            echo "AUTO_REPLY_MIN_DELAY=${AUTO_REPLY_MIN_DELAY:-5}"
            echo "AUTO_REPLY_MAX_DELAY=${AUTO_REPLY_MAX_DELAY:-15}"
            echo "SESSION_NAME=data/userbot_session"
          } > /tmp/.env
          
          # Copy .env file to server
          scp -i ~/.ssh/deploy_key /tmp/.env "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/.env"
          
          # Deploy to server
          ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=60 -o ServerAliveCountMax=10 "${SSH_USER}@${SSH_HOST}" "cd ${DEPLOY_PATH} && bash -s" << 'ENDSSH'
            set -e
            
            echo "==> Pulling latest code..."
            git pull origin main
            
            echo "==> Creating data directory..."
            mkdir -p data
            
            echo "==> Stopping existing containers..."
            docker compose down || true
            
            echo "==> Building Docker image (this may take a few minutes)..."
            docker compose build --no-cache
            
            echo "==> Starting containers..."
            docker compose up -d
            
            echo "==> Waiting for container to be ready..."
            sleep 5
            
            echo "==> Container status:"
            docker compose ps
            
            echo "==> Deployment completed!"
          ENDSSH
      
      - name: Verify deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Check if container is running
          ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=60 "${SSH_USER}@${SSH_HOST}" "cd ${DEPLOY_PATH} && bash -s" << 'ENDSSH'
            echo "==> Container status:"
            docker compose ps
            echo ""
            echo "==> Recent logs:"
            docker compose logs --tail=30
          ENDSSH
